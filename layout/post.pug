extends widget/base
block append head
    link(rel='stylesheet', href= url_for('/style/post.css'))
    link(rel='stylesheet', href= url_for('/style/widget-post-list.css'))
    if theme.highlight
        link(rel='stylesheet', href= url_for('/style/themes/highlight-theme-light.css'))

    meta(name="description", content!= truncate( strip_html(page.content), {length: 360, omission: '..'} ))
    if theme.comment_valine && theme.comment_valine.enable
        script(src="//unpkg.com/valine/dist/Valine.min.js")
block topic
    div#postTopic.is-full-height
        - let title = truncate( page.title, {length: 65, omission: '..'} ) || ''
        p.is-full-height.is-flex-shrink-0.is-flex.is-align-items-center.is-justify-content-center= title
        p.is-full-height.is-flex-shrink-0.is-flex.is-align-items-center.is-justify-content-center= __('click_back_to_the_top')

block content
    include widget/methods
    -
        function parseContent(content) {
            return content.replace(/<img([\w\W]+?)>/g, function(img) {
                let srcset = ''
                let src = ''
                let alt = ''
                img.replace(/src="([^"]+)"/, function(str) {
                    src = str.slice(5, -1)
                    srcset = getSrcset(src)
                })
                img.replace(/alt="([^"]+)"/, function(str) {
                    alt = str.slice(5, -1)
                })
                let imgtag = `<img src="${src}" srcset="${srcset}" alt="${alt}" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw" loading="lazy">`
                if (alt) {
                    return `<figure>${imgtag}<figcaption>${alt}</figcaption></figure>`
                }
                return `<figure>${imgtag}</figure>`
            }).replace(/<iframe([\w\W]+?)>/g, function(iframe) {
                let src
                iframe.replace(/src="([^"]+)"/, function(str) {
                    src = new URL(str.slice(5, -1))
                })
                if (src && src.origin === 'https://iframe.videodelivery.net') {
                    const srcdoc = `<!DOCTYPE html><html><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/><meta name="description" content="Stream"/><title>Stream</title><style>html, body { height: 100%; } body { margin: 0px; overflow: hidden;}</style></head><body><stream width="100%" height="100%" src="${ src.pathname.slice(1) }"${ src.searchParams.get('preload') === 'true' ? ' preload=auto' : src.searchParams.get('preload') === 'metadata' ? ' metadata' : '' }${ src.searchParams.get('autoplay') === 'true' ? ' autoplay' : '' }${ src.searchParams.get('controls') === 'false' ? '' : ' controls' }${ src.searchParams.get('poster') ? ` poster="${ src.searchParams.get('poster') }"` : '' }${ src.searchParams.get('muted') === 'true' ? ' muted' : '' }${ src.searchParams.get('loop') === 'true' ? ' loop' : '' }${ src.searchParams.get('startTime') ? ` start-time="${ src.searchParams.get('startTime') }` : '' }${ src.searchParams.get('primaryColor') ? ` primary-color="${ src.searchParams.get('primaryColor') }"` : '' }></stream><script data-cfasync="false" defer="" type="text/javascript" src="/js/sdk-iframe-integration.fla9.latest.js"></script></body></html>`
                    return `<iframe srcdoc='${srcdoc}' loading="lazy"${iframe.slice(7)}`
                }
                return `<iframe loading="lazy"${iframe.slice(7)}`
            })
        }
    - const tocContent = toc(page.content + `<h2 id="footer">${__('comment')}</h2>`, {list_number: false})
    main.container.section.post-page.pt-4.px-4
        .columns.content.is-flex-desktop.is-justify-content-center.is-flex-direction-row-reverse
            .column.is-3.toc-container.is-hidden-mobile!= tocContent
            .column.is-9
                header.my-4
                    if page.tags && page.tags.length > 0
                        each tag in page.tags.toArray()
                            a(href= url_for(`/tags/${tag.name}`))
                                if __(`${config.language2}.${tag.name}`) != `${config.language2}.${tag.name}`
                                    i.tag.post-item-tag
                                        span(lang=config.language1)= tag.name
                                        span.is-hidden(lang=config.language2)= __(`${config.language2}.${tag.name}`)
                                else
                                    i.tag.post-item-tag= tag.name
                if page.title_cn
                    h1.mt-0.mb-1.is-family-serif#postTitle
                        span(lang="en-US")= page.title
                        span.is-hidden(lang="zh-CN")= page.title_cn
                else
                    h1.mt-0.mb-1.is-family-serif#postTitle= page.title
                if page.date
                    time.has-text-grey(datetime=page.date.toJSON())= date(page.date, date_format)
                article.mt-2.post-content
                    div.is-hidden-tablet.mb-4
                        h2= __('toc')
                        != tocContent
                    div!= parseContent(page.content)
                if page.video
                    a.button.is-default.mt-2.has-text-weight-semibold(href=`https://videodelivery.net/${page.video}/downloads/default.mp4` target="_blank" rel="noopener nofollow" lang=config.language1)= __('download_movie')
                    a.button.is-default.mt-2.has-text-weight-semibold.is-hidden(href=`https://videodelivery.net/${page.video}/downloads/default.mp4` target="_blank" rel="noopener nofollow" lang=config.language2)= __(`${config.language2}.download_movie`)
                //- section.jump-container.is-flex.is-justify-content-space-between.my-6
                //-     // em is empty placeholder
                //-     if page.prev
                //-         - const preContent= `${ page.prev.title }`
                //-         a.button.is-default(href= url_for(page.prev.path) title= page.prev.title)
                //-             i.iconfont.icon-prev.mr-2.has-text-grey
                //-             span.has-text-weight-semibold= preContent
                //-     else
                //-         em
                //-     if page.next
                //-         - const nextContent= `${ page.next.title }`
                //-         a.button.is-default(href= url_for(page.next.path) title= page.next.title)
                //-             span.has-text-weight-semibold= nextContent
                //-             i.iconfont.icon-next.ml-2.has-text-grey

        div#footer
        .columns.is-flex-desktop.is-justify-content-center.comment-container.mt-1.pt-3
            section.column.comment-box
                if theme.comment_utteranc && theme.comment_utteranc.enable && (page.comments || typeof page.comments === "undefined")
                    article.comment
                        script(
                            async
                            repo= theme.comment_utteranc.repo
                            src= "https://utteranc.es/client.js"
                            label= theme.comment_utteranc.label
                            issue-term= theme.comment_utteranc.issue_term || "pathname"
                            theme= theme.comment_utteranc.theme || "preferred-color-scheme"
                        )
                if theme.comment_valine && theme.comment_valine.enable
                    article.comment#vcomments(
                        data-comment_valine_id= theme.comment_valine.appId
                        data-comment_valine_key= theme.comment_valine.appKey
                    )
                if theme.comment_disqus && theme.comment_disqus.enable
                    div#disqus_thread
                    article.comment#disqus
                        script="var disqus_config = function () {this.page.url = '"+theme.comment_disqus.url+url_for(page.path)+"';this.page.identifier = '"+theme.comment_disqus.name+"';};"
                        script="(function() {var d = document, s = d.createElement('script');s.src = 'https://"+theme.comment_disqus.name+".disqus.com/embed.js';s.setAttribute('data-timestamp', +new Date());(d.head || d.body).appendChild(s);})();"
                        script(id="dsq-count-scr", src="//blog-pubgj2togw.disqus.com/count.js", async)
            aside.column.is-4-tablet.is-3-widescreen.post-container
                include widget/widget-recent-content-all
                if theme.links && theme.links.length > 0
                    include widget/widget-links

block script
    script(src= url_for("/js/post.js"))
    script(async src= url_for("/js/highlight.pack.js") onload="hljs.highlightAll()")
